#!/usr/bin/env php
<?php

declare(strict_types=1);

// Determine the base directory (where this script lives)
$binDir = dirname(__FILE__);
$baseDir = dirname($binDir);

// Find autoloader
$autoloadPaths = [
    $baseDir . '/vendor/autoload.php',
    $baseDir . '/../../autoload.php', // When installed as a dependency
];

$autoloaderFound = false;
foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        $autoloaderFound = true;
        break;
    }
}

if (!$autoloaderFound) {
    fwrite(STDERR, "Could not find autoloader. Run 'composer install' first.\n");
    exit(1);
}

use HarPhp\Application;

// Load .env.local from multiple locations
$envLocations = [
    getcwd() . '/.env.local',
    $baseDir . '/.env.local',
];

$envVars = [];
foreach ($envLocations as $envPath) {
    if (file_exists($envPath)) {
        $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        foreach ($lines as $line) {
            $line = trim($line);
            if ($line === '' || str_starts_with($line, '#')) {
                continue;
            }
            if (str_contains($line, '=')) {
                [$key, $value] = explode('=', $line, 2);
                $key = trim($key);
                $value = trim($value);
                // Remove surrounding quotes if present
                if ((str_starts_with($value, '"') && str_ends_with($value, '"')) ||
                    (str_starts_with($value, "'") && str_ends_with($value, "'"))) {
                    $value = substr($value, 1, -1);
                }
                // Don't override existing env vars, first file wins
                if (!isset($envVars[$key])) {
                    $envVars[$key] = $value;
                }
            }
        }
    }
}

// Set environment variables
foreach ($envVars as $key => $value) {
    if (getenv($key) === false) {
        putenv("$key=$value");
        $_ENV[$key] = $value;
    }
}

// Resolve filter config path relative to bin dir or cwd
$filterConfig = getenv('HARPHP_FILTER') ?: null;
if ($filterConfig && !file_exists($filterConfig)) {
    // Try relative to cwd first
    $cwdPath = getcwd() . '/' . $filterConfig;
    $binPath = $baseDir . '/' . $filterConfig;
    
    if (file_exists($cwdPath)) {
        putenv("HARPHP_FILTER=$cwdPath");
        $_ENV['HARPHP_FILTER'] = $cwdPath;
    } elseif (file_exists($binPath)) {
        putenv("HARPHP_FILTER=$binPath");
        $_ENV['HARPHP_FILTER'] = $binPath;
    }
}

$application = new Application($baseDir);
$application->run();
